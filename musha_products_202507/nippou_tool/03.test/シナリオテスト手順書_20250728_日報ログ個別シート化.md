# シナリオテスト手順書_20250728_日報ログ二重書き込み対応

## 1. テスト概要

日報ログの保存形式を、従来の単一シートから「メインの全データシート」と「メンバーごとの個別シート」への二重書き込みに変更したことに伴い、関連機能が正常に動作することを確認する。また、日報要約AIの全機能（日報質問送信、日報取得・分析、週次レポート生成、トリガー管理）が正常に動作し、特に1on1ヒアリング項目生成機能の削除による影響がないことを確認する。

## 2. テスト環境

*   **スプレッドシート**: テスト用のスプレッドシートを使用する。
    *   `日報ログ`シートが存在し、ヘッダーが正しく設定されていること。
    *   `BOT質問ログ`シートが存在し、ヘッダーが正しく設定されていること。
    *   `Chatwork設定`シートが存在し、ヘッダーが正しく設定されていること。
*   **Chatwork**: テスト用のアカウント、ルームを使用する。
*   **テストデータ**:
    *   `Chatwork設定`シートに、テスト用のマネージャー、社員（複数名）を登録しておく。
    *   必要に応じて、`日報ログ`シートに過去の日報データを準備する。
    *   スクリプトプロパティに`CHATWORK_API_KEY`と`GEMINI_API_KEY`が正しく設定されていること。

## 3. テストシナリオ

### 3.1. 正常系テスト

#### 3.1.1. 日報提出とログの二重書き込み

| テストケースNo. | 手順 | 確認事項 |
| :--- | :--- | :--- |
| 1-1 | 社員Aが日報を提出する。（初回） | ・`日報ログ`シートに、AI評価を含む全ての日報データが記録されること。<br>・`日報ログ_社員A_{ルームID}`という名前のシートが新規作成されること。<br>・作成された個別シートの1行目に、AI評価を含まないヘッダーが正しく設定されていること。<br>・個別シートの2行目に、AI評価を含まない日報データが正しく記録されていること。<br>・個別シートのヘッダー行が固定され、列幅が正しく設定されていること。 |
| 1-2 | 社員Aが再度日報を提出する。 | ・`日報ログ`シートに新しい日報データが追記されること。<br>・`日報ログ_社員A_{ルームID}`シートの3行目に、新しい日報データが追記されていること。 |
| 1-3 | 社員Bが日報を提出する。 | ・`日報ログ`シートに新しい日報データが追記されること。<br>・`日報ログ_社員B_{ルームID}`という名前のシートが新規作成され、日報データが記録されること。 |

#### 3.1.2. 日報質問送信機能 (`sendDailyReportQuestions`)

| テストケースNo. | 手順 | 確認事項 |
| :--- | :--- | :--- |
| 2-1 | `createDailyTriggers`を実行し、質問送信トリガーが設定された後、指定時刻に`sendDailyReportQuestions`が実行されることを確認する。（または手動で`sendDailyReportQuestions`を実行） | ・`Chatwork設定`シートに登録された全社員（マネージャーを除く）に日報質問メッセージが送信されること。<br>・`BOT質問ログ`シートに、送信された質問のルームID、メッセージID、タイムスタンプ、ステータス（`未返信`）が正しく記録されること。<br>・マネージャーには質問が送信されないこと。 |
| 2-2 | 社員Aに未返信の日報質問がある状態で、再度`sendDailyReportQuestions`を実行する。 | ・社員Aには質問が再送信されないこと。<br>・`BOT質問ログ`シートの社員Aのステータスが`未返信`のままであること。 |

#### 3.1.3. Chatwork日報取得・分析機能 (`processChatworkReplies`)

| テストケースNo. | 手順 | 確認事項 |
| :--- | :--- | :--- |
| 3-1 | 社員Aが正しいフォーマットで日報を返信する。`processChatworkReplies`を実行する。 | ・日報が正しく解析され、`日報ログ`シートおよび社員Aの個別シートに記録されること。<br>・`BOT質問ログ`シートの社員Aの質問ステータスが`返信済み_処理成功`に更新されること。<br>・Gemini AIによる評価が正しく行われ、`日報ログ`シートにAI評価状態と理由が記録されること。<br>・AI評価が「危険」「少し悪い」「悪い」の場合、マネージャーにChatwork通知が送信されること。<br>・AI評価が「普通」で「困っていること」に記載がある場合、マネージャーにChatwork通知が送信されること。 |
| 3-2 | 社員Bがフォーマットを崩して日報を返信する。`processChatworkReplies`を実行する。 | ・日報が解析されず、`日報ログ`シートおよび社員Bの個別シートに記録されないこと。<br>・`BOT質問ログ`シートの社員Bの質問ステータスが`返信済み_フォーマット不正`に更新されること。<br>・マネージャーに通知が送信されないこと。 |
| 3-3 | 社員Cがフォーマット不正の日報を返信し、ステータスが`返信済み_フォーマット不正`になった後、再度`processChatworkReplies`を実行する。 | ・社員Cの日報処理がスキップされること。<br>・`BOT質問ログ`シートの社員Cのステータスが`返信済み_フォーマット不正`のままであること。 |

#### 3.1.4. 週次レポート生成機能 (`generateWeeklyReports`)

| テストケースNo. | 手順 | 確認事項 |
| :--- | :--- | :--- |
| 4-1 | `Chatwork設定`シートでマネージャーの「週次レポートモード」を`individual`に設定する。複数社員の日報データが`日報ログ`シートに存在することを確認し、メニューから「週次レポート生成」を実行する。 | ・各社員の過去1週間分の日報データが正しく集計されること。<br>・Gemini AIにより、各社員個別の週次レポートが生成されること。<br>・マネージャーに、各社員のレポートをまとめたChatwork通知が送信されること。 |
| 4-2 | `Chatwork設定`シートでマネージャーの「週次レポートモード」を`team`に設定する。複数社員の日報データが`日報ログ`シートに存在することを確認し、メニューから「週次レポート生成」を実行する。 | ・チーム全体の過去1週間分の日報データが正しく集計されること。<br>・Gemini AIにより、チーム全体の週次サマリーレポートが生成されること。<br>・マネージャーに、チームサマリーレポートのChatwork通知が送信されること。 |
| 4-3 | 過去1週間の日報データがない状態でメニューから「週次レポート生成」を実行する。 | ・レポートが生成されず、マネージャーに通知が送信されないこと。<br>・ログに「過去1週間の日報データが見つかりませんでした。」というメッセージが出力されること。 |

#### 3.1.5. トリガー管理機能 (`createDailyTriggers`, `deleteTriggers`, `cleanUpBotQuestionLog`)

| テストケースNo. | 手順 | 確認事項 |
| :--- | :--- | :--- |
| 5-1 | メニューから「全てのトリガーを削除」を実行後、「定期実行トリガーを設定」を実行する。 | ・`sendDailyReportQuestions`、`processChatworkReplies`、`generateWeeklyReports`、`cleanUpBotQuestionLog`のトリガーが正しく作成されていること。<br>・各トリガーが設定された時刻・曜日に実行されるように設定されていること。 |
| 5-2 | メニューから「定期実行トリガーを設定」を実行後、「全てのトリガーを削除」を実行する。 | ・作成されたすべてのトリガーが削除されていること。 |
| 5-3 | `BOT質問ログ`シートに、`返信済み_処理成功`のステータスのログと、7日以上前の`未返信`または`エラー発生`のステータスのログを準備する。`cleanUpBotQuestionLog`を実行する。 | ・`返信済み_処理成功`のログが削除されること。<br>・7日以上前の`未返信`または`エラー発生`のログが削除されること。<br>・7日以内の`未返信`または`エラー発生`のログは削除されないこと。 |

### 3.2. 異常系テスト

#### 3.2.1. メインログシートが存在しない場合

| テストケースNo. | 手順 | 確認事項 |
| :--- | :--- | :--- |
| 6-1 | `日報ログ`シートを削除、または名前を変更した状態で、いずれかの社員が日報を提出する。 | ・処理がエラーとなり、`logReportToSheet`関数で「シートが見つかりません」という趣旨のエラーがログに出力されること。<br>・メンバーごとの個別シートも作成・更新されないこと。 |

#### 3.2.2. Chatwork APIキーが未設定の場合

| テストケースNo. | 手順 | 確認事項 |
| :--- | :--- | :--- |
| 7-1 | スクリプトプロパティから`CHATWORK_API_KEY`を削除した状態で、メニューから「日報質問送信（Chatwork）」を実行する。 | ・エラーが発生し、ログに「Chatwork API Key is not set in Script Properties.」というメッセージが出力されること。<br>・質問が送信されないこと。 |
| 7-2 | スクリプトプロパティから`CHATWORK_API_KEY`を削除した状態で、メニューから「Chatwork日報取得・分析」を実行する。 | ・エラーが発生し、ログに「Chatwork API Key is not set in Script Properties.」というメッセージが出力されること。<br>・日報が処理されないこと。 |

#### 3.2.3. 日報フォーマット不正の場合

| テストケースNo. | 手順 | 確認事項 |
| :--- | :--- | :--- |
| 8-1 | 社員が日報の「気分」に`良い/普通/少し悪い/悪い`以外の値を入力して返信する。`processChatworkReplies`を実行する。 | ・`validateDailyReport`関数でバリデーションエラーとなり、`BOT質問ログ`シートのステータスが`返信済み_フォーマット不正`に更新されること。<br>・ログに「気分に不正な値...」というメッセージが出力されること。 |
| 8-2 | 社員が日報の「業務内容」を空にして返信する。`processChatworkReplies`を実行する。 | ・`validateDailyReport`関数でバリデーションエラーとなり、`BOT質問ログ`シートのステータスが`返信済み_フォーマット不正`に更新されること。<br>・ログに「業務内容が空です。」というメッセージが出力されること。 |

#### 3.2.4. Chatwork設定シートに不備がある場合

| テストケースNo. | 手順 | 確認事項 |
| :--- | :--- | :--- |
| 9-1 | `Chatwork設定`シートの必須列（例: `グループ名`）のヘッダーを削除または変更した状態で、メニューから「日報質問送信（Chatwork）」または「Chatwork日報取得・分析」を実行する。 | ・`getChatworkTargetRoomIds`関数でエラーとなり、ログに「必要な列「...」がありません。」というメッセージが出力されること。<br>・以降の処理が実行されないこと。 |
| 9-2 | `Chatwork設定`シートで、社員は登録されているが、そのグループのマネージャーが登録されていない、または役割が`manager`になっていない状態で、メニューから「日報質問送信（Chatwork）」または「Chatwork日報取得・分析」を実行する。 | ・該当社員が処理対象からスキップされ、ログに「対応するマネージャーが見つかりません。」という警告が出力されること。 |
