# システム相関図 - 面談データ分析AIツール (Interview Analyzer)

## 概要

本ドキュメントは、面談データ分析AIツール「Interview Analyzer」の主要なコンポーネントと、それらの間のデータの流れ、相互作用を示すシステム相関図です。

## システム構成図 (テキストベース)

```
+--------------------+
|       ユーザー     |
| (GUI操作)          |
+---------+----------+
          |
          | (1) モード選択 (新規分析 or 既存で対話 or 日報分析)
          v
+--------------------+
|  Interview Analyzer|
|    (app_gui.py)    | --(I) 処理ログ出力--> +--------------------+
+---------+----------+                      |      logsフォルダ  |
          | (2) 設定読み込み                | (YYYYMMDD_HHMMSS.log)|
          v                                 +--------------------+
+--------------------+
|     config.ini     |
| (AIバックエンド選択)|
| (APIキー/Ollama設定)|
| (日報集計期間)     |
+--------------------+

          +--------------------------------------------------+
          | (モード1: 面談分析)                              | (モード3: 日報分析)
          v                                                  v
+--------------------+                               +--------------------+
| (3) ファイルパス入力 |                               | (A) 日報ファイル入力 |
+---------+----------+                               +---------+----------+
          |                                                  |
          | (4) データ読み込み                               | (B) シートごとのデータ読込
          v                                                  v
+--------------------+                               +--------------------+
|   入力データファイル |                               |   入力日報ファイル |
| (Excel/CSV)        |                               | (Excel)            |
+---------+----------+                               +---------+----------+
          |                                                  |
          | (5) AIによるデータ構造分析                         | (C) 日報内容の期間集計
          v                                                  v
+--------------------+                               +--------------------+
|   データフレーム   |                               |   データフレーム   |
|    (Pandas)        |                               |    (Pandas)        |
+---------+----------+                               +---------+----------+
          |                                                  |
          | (6) AI要約・アドバイス生成リクエスト             | (D) AI要約・アドバイス・危険信号判定リクエスト
          v                                                  v
+--------------------+                               +--------------------+
|    AIバックエンド  |                               |    AIバックエンド  |
| (Google Gemini API)|                               | (Google Gemini API)|
| (ローカル Ollama)  |                               | (ローカル Ollama)  |
+---------+----------+                               +---------+----------+
          |                                                  |
          | (7) 要約・アドバイス応答                         | (E) 要約・アドバイス・危険信号応答
          v                                                  v
+--------------------+                               +--------------------+
|   データフレーム   |                               |   データフレーム   |
| (要約・アドバイス追加)|                               | (日報分析結果追加) |
+---------+----------+                               +---------+----------+
          |
          | (8) 従業員別CSV出力
          v
+--------------------+
|   出力データファイル |
| (要約結果/個別CSV) |
+--------------------+
          | (9) データベースへ保存
          v
+--------------------+
|   Database (SQLite)|
| (analyzer_data.db) |
+---------+----------+
          ^
          | (H) 既存データ読込 (AI質問応答用)
          |
+--------------------+
| (モード2: 既存で対話) |
+--------------------+
          |
          v
+--------------------+                               +--------------------+
|   データフレーム   |                               |       ユーザー     |
| (結合済み)         |                               | (AI回答表示)       |
| (知識ベースとして利用) |                               +--------------------+
+--------------------+
```

## 主要コンポーネントとデータの流れ

1.  **ユーザー**: ツールの操作者。モード選択、ファイル/ディレクトリパスの入力、AIへの質問を行う。**各処理完了後、GUIは操作可能な状態に戻ります。**
2.  **Interview Analyzer (app_gui.py)**: ツールの主要なロジックを実装したPythonスクリプト。ユーザーからの入力を受け付け、データ処理、AI連携、ファイル出力、**データベースへの保存・読み込みも制御する**AI質問応答セッションを提供する。
3.  **config.ini**: ツールの設定ファイル。使用するAIバックエンド（Gemini/Ollama）の選択、APIキーやOllamaサーバーのURL・モデル名、日報の集計期間などの設定情報を保持する。
4.  **入力データファイル (面談)**: 分析対象となる面談データが格納されたファイル。Excel (.xlsx) または CSV (.csv) 形式に対応。複数従業員のデータが単一ファイルに集約されている形式、または従業員ごとの個別ファイルがフォルダに格納されている形式のいずれかを受け付ける。
5.  **入力日報ファイル**: 分析対象となる日報データが格納されたExcelファイル (.xlsx)。各シートが1人の従業員の日報データに対応する。**タイムスタンプ列は `YYYY/MM/DD HH:MM:SS` 形式を想定します。**
6.  **AIによるデータ構造分析 (面談)**: 入力面談データ（単一ファイルまたはディレクトリ内の各ファイル）のヘッダーとサンプルをAIに渡し、データ構造が「横持ち」か「縦持ち」かを判断させる。同時に、AIはデータ内の「従業員を識別する列/項目」「面談のフリーコメントを含む列/項目」「得意分野を示す列/項目」を**厳密に特定**する。縦持ちデータの場合は、この段階で横持ちへの変換に必要な情報（項目列名、値列名、各項目名）も特定される。
7.  **データフレーム (Pandas)**: PythonのPandasライブラリによって管理される表形式のデータ。入力データを読み込み、AIによる構造分析と必要に応じた変換を経て、AI処理に適した統一的なデータ構造に整形される。
8.  **AIバックエンド (Google Gemini API / ローカル Ollama)**: AIによる要約、アドバイス生成、危険信号判定、質問応答の処理を行う外部サービスまたはローカル環境。`config.ini` の設定に基づいて切り替えられる。
    *   **Google Gemini API**: Googleが提供する大規模言語モデルAPI。インターネット経由で利用する。
*   **ローカル Ollama**: ユーザーのPC上で動作するオープンソースの大規模言語言語モデル実行環境。HTTP API経由で利用する。
9.  **出力データファイル (面談)**: AIによる要約・アドバイスが追加された面談データ。従業員ごとに個別のCSVファイルとして `面談要約結果` フォルダに出力される。ファイル名は従業員名を含む形式となる。
10. **出力データファイル (日報)**: AIによる要約・アドバイス・危険信号が追加された日報データ。従業員ごと・期間ごとに個別のCSVファイルとして `日報分析結果` フォルダに出力される。ファイル名は従業員名と期間を含む形式となる。**危険信号の判断基準は、業務上の問題、体調不良のいずれか、または複数に該当するかを判断します。**
11. **AI質問応答セッション**: **データベースに保存された**面談要約データと日報分析データの内容を知識ベースとして利用し、ユーザーからの質問に対してAIが回答を生成する対話型インターフェース。
12. **logsフォルダ**: ツールの実行中に発生した処理の進捗、警告、エラーなどのログ情報が、日付と時刻を含むファイル名で自動的に格納されるディレクトリ。
13. **Database (SQLite)**: 面談要約結果および日報分析結果を保存するローカルデータベース (`analyzer_data.db`)。AI質問応答機能の知識ベースとして利用される。

## 凡例

*   **四角い枠**: システムの主要なコンポーネントやデータストア
*   **矢印**: データの流れや処理の方向
*   **番号**: 処理の順序やデータのフローを示す
*   **点線矢印**: オプションの処理フローや条件分岐
*   **雲のアイコン**: 外部サービスやクラウド環境
*   **PCのアイコン**: ローカル環境やユーザーのPC

## フローの番号付けとドキュメント参照

図中の番号は、以下のドキュメントの対応するセクションと関連しています。

*   **要件定義書**: 各機能の要件定義
*   **詳細設計書**: 各モジュールや関数の詳細な実装内容

## 外部依存サービスの明記

```
+--------------------+
|       ユーザー     |
+---------+----------+
          |
          | (操作)
          v
+--------------------+
|  Interview Analyzer|
|    (ローカルPC)    |
+---------+----------+
          |
          | (APIリクエスト)
          v
+--------------------+
|    AIバックエンド  |
| (Google Gemini API)|
| (ローカル Ollama)  |
+---------+----------+
    |             |
    |             |
    v             v
+-------+     +-------+
| Google|     | Ollama|
| Cloud |     | (ローカル)|
| (外部) |     |       |
+-------+     +-------+
```
